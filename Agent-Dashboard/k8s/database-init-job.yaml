apiVersion: batch/v1
kind: Job
metadata:
  name: livekit-dashboard-db-init
  namespace: livekit
  labels:
    app: livekit-dashboard
    component: database-init
spec:
  template:
    metadata:
      labels:
        app: livekit-dashboard
        component: database-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-db
        image: postgres:17-alpine
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Initializing livekit_dashboard database..."
          
          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL cluster..."
          until PGPASSWORD=$POSTGRES_PASSWORD psql -h $PGHOST -U $POSTGRES_USER -d postgres -c '\q' 2>/dev/null; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is ready!"
          
          # Check if database already exists
          DB_EXISTS=$(PGPASSWORD=$POSTGRES_PASSWORD psql -h $PGHOST -U $POSTGRES_USER -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='livekit_dashboard'")
          
          if [ "$DB_EXISTS" = "1" ]; then
            echo "Database 'livekit_dashboard' already exists"
          else
            echo "Creating database 'livekit_dashboard'..."
            PGPASSWORD=$POSTGRES_PASSWORD psql -h $PGHOST -U $POSTGRES_USER -d postgres -c "CREATE DATABASE livekit_dashboard"
            echo "Database 'livekit_dashboard' created successfully!"
          fi
          
          # Verify database is accessible
          echo "Verifying database access..."
          PGPASSWORD=$POSTGRES_PASSWORD psql -h $PGHOST -U $POSTGRES_USER -d livekit_dashboard -c "SELECT version();" || {
            echo "❌ Failed to connect to livekit_dashboard database"
            exit 1
          }
          
          echo "✅ Database 'livekit_dashboard' is ready and accessible!"
          echo "✅ Database initialization complete"
        env:
        - name: PGHOST
          value: pg-haproxy-primary.pg.svc.cluster.local
        - name: PGPORT
          value: "5432"
        - name: POSTGRES_USER
          value: livekit
        - name: POSTGRES_PASSWORD
          value: L1v3K1tTh1515T0p53cr3t
        - name: PGPASSWORD
          value: L1v3K1tTh1515T0p53cr3t

